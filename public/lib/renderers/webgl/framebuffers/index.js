(function(exports){"use strict";const GL=WebGLRenderingContext;(function(Attachment){Attachment[Attachment["Color0"]=GL.COLOR_ATTACHMENT0]="Color0";Attachment[Attachment["Depth"]=GL.DEPTH_ATTACHMENT]="Depth";Attachment[Attachment["DepthStencil"]=GL.DEPTH_STENCIL_ATTACHMENT]="DepthStencil";Attachment[Attachment["Stencil"]=GL.STENCIL_ATTACHMENT]="Stencil"})(exports.Attachment||(exports.Attachment={}));(function(BufferBit){BufferBit[BufferBit["None"]=0]="None";BufferBit[BufferBit["Color"]=GL.COLOR_BUFFER_BIT]="Color";BufferBit[BufferBit["Depth"]=GL.DEPTH_BUFFER_BIT]="Depth";BufferBit[BufferBit["Stencil"]=GL.STENCIL_BUFFER_BIT]="Stencil";BufferBit[BufferBit["Default"]=BufferBit.Color|BufferBit.Depth]="Default";BufferBit[BufferBit["All"]=BufferBit.Color|BufferBit.Depth|BufferBit.Stencil]="All"})(exports.BufferBit||(exports.BufferBit={}));const arrayBuffer=new ArrayBuffer(12*16);const floatArray=new Float32Array(arrayBuffer);const intArray=new Int32Array(arrayBuffer);function hashFloat2(v0,v1){floatArray[0]=v0;floatArray[1]=v1;const hash=intArray[0];return hash*397^intArray[1]}function clamp(value,min,max){return Math.min(Math.max(value,min),max)}function isPow2(value){return(value&value-1)===0&&value!==0}class Vector2{constructor(x=0,y=0){this.x=x;this.y=y}get width(){return this.x}set width(width){this.x=width}get height(){return this.y}set height(height){this.y=height}getHashCode(){return hashFloat2(this.x,this.y)}set(x,y){this.x=x;this.y=y;return this}clone(){return(new Vector2).copy(this)}copy(v){return this.set(v.x,v.y)}add(v){this.x+=v.x;this.y+=v.y;return this}addScalar(s){this.x+=s;this.y+=s;return this}sub(v){this.x-=v.x;this.y-=v.y;return this}multiplyByScalar(s){this.x*=s;this.y*=s;return this}negate(){this.x*=-1;this.y*=-1;return this}normalize(){const length=this.length();return this.multiplyByScalar(length===0?1:0)}getComponent(index){if(index===0){return this.x}else if(index===1){return this.y}else{throw new Error(`index of our range: ${index}`)}}setComponent(index,value){if(index===0){this.x=value}else if(index===1){this.y=value}else{throw new Error(`index of our range: ${index}`)}return this}dot(v){return this.x*v.x+this.y*v.y}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y}min(v){this.x=Math.min(this.x,v.x);this.y=Math.min(this.y,v.y);return this}max(v){this.x=Math.max(this.x,v.x);this.y=Math.max(this.y,v.y);return this}clamp(min,max){this.x=clamp(this.x,min.x,max.x);this.y=clamp(this.y,min.y,max.y);return this}equals(v){return v.x===this.x&&v.y===this.y}setFromArray(array,offset){this.x=array[offset+0];this.y=array[offset+1]}toArray(array,offset){array[offset+0]=this.x;array[offset+1]=this.y}}class Box2{constructor(min=new Vector2(+Infinity,+Infinity),max=new Vector2(+Infinity,+Infinity)){this.min=min;this.max=max}get x(){return this.min.x}get y(){return this.min.y}get left(){return this.min.x}get top(){return this.min.y}get width(){return this.max.x-this.min.x}get height(){return this.max.y-this.min.y}get bottom(){return this.max.y}get right(){return this.max.x}getHashCode(){return hashFloat2(this.min.getHashCode(),this.max.getHashCode())}set(min,max){this.min.copy(min);this.max.copy(max);return this}clone(){return(new Box2).copy(this)}copy(box){this.min.copy(box.min);this.max.copy(box.max);return this}getCenter(v){return v.set((this.min.x+this.max.x)*.5,(this.min.y+this.max.y)*.5)}makeEmpty(){this.min.x=this.min.y=+Infinity;this.max.x=this.max.y=-Infinity;return this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}union(box){this.min.min(box.min);this.max.max(box.max);return this}translate(offset){this.min.add(offset);this.max.add(offset);return this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}}class VirtualFramebuffer{constructor(context){this.context=context;this.disposed=false;this.cullingState=undefined;this.clearState=undefined;this.depthTestState=undefined;this.blendState=undefined;this.maskState=undefined;this.viewport=undefined}clear(attachmentBits=exports.BufferBit.Color|exports.BufferBit.Depth,clearState=undefined){var _a;this.context.framebuffer=this;this.context.clearState=(_a=clearState!==null&&clearState!==void 0?clearState:this.clearState)!==null&&_a!==void 0?_a:this.context.clearState;const gl=this.context.gl;gl.clear(attachmentBits)}render(node,camera,clear=false){this.context.framebuffer=this;if(clear){this.clear()}this.context.render(node,camera)}flush(){this.context.gl.flush()}finish(){this.context.gl.finish()}}function renderBufferGeometry(framebuffer,program,uniforms,bufferGeometry,depthTestState=undefined,blendState=undefined,maskState=undefined,cullingState=undefined){var _a,_b,_c,_d;const context=framebuffer.context;context.framebuffer=framebuffer;context.blendState=(_a=blendState!==null&&blendState!==void 0?blendState:framebuffer.blendState)!==null&&_a!==void 0?_a:context.blendState;context.depthTestState=(_b=depthTestState!==null&&depthTestState!==void 0?depthTestState:framebuffer.depthTestState)!==null&&_b!==void 0?_b:context.depthTestState;context.maskState=(_c=maskState!==null&&maskState!==void 0?maskState:framebuffer.maskState)!==null&&_c!==void 0?_c:context.maskState;context.cullingState=(_d=cullingState!==null&&cullingState!==void 0?cullingState:framebuffer.cullingState)!==null&&_d!==void 0?_d:context.cullingState;context.program=program;context.program.setUniformValues(uniforms);context.program.setAttributeBuffers(bufferGeometry);context.viewport=new Box2(new Vector2,framebuffer.size);const gl=context.gl;if(bufferGeometry.indices!==undefined){gl.drawElements(bufferGeometry.primitive,bufferGeometry.count,bufferGeometry.indices.componentType,0)}else{gl.drawArrays(bufferGeometry.primitive,0,bufferGeometry.count)}}function renderVertexArrayObject(framebuffer,program,uniforms,vao,depthTestState=undefined,blendState=undefined,maskState=undefined,cullingState=undefined){var _a,_b,_c,_d;const context=framebuffer.context;context.framebuffer=framebuffer;context.blendState=(_a=blendState!==null&&blendState!==void 0?blendState:framebuffer.blendState)!==null&&_a!==void 0?_a:context.blendState;context.depthTestState=(_b=depthTestState!==null&&depthTestState!==void 0?depthTestState:framebuffer.depthTestState)!==null&&_b!==void 0?_b:context.depthTestState;context.maskState=(_c=maskState!==null&&maskState!==void 0?maskState:framebuffer.maskState)!==null&&_c!==void 0?_c:context.maskState;context.cullingState=(_d=cullingState!==null&&cullingState!==void 0?cullingState:framebuffer.cullingState)!==null&&_d!==void 0?_d:context.cullingState;context.program=program;context.program.setUniformValues(uniforms);context.viewport=new Box2(new Vector2,framebuffer.size);const gl=context.gl;gl.drawArrays(vao.primitive,vao.offset,vao.count)}function renderPass(framebuffer,program,uniforms,depthTestState=undefined,blendState=undefined,maskState=undefined,cullingState=undefined){var _a,_b,_c,_d;const context=framebuffer.context;context.framebuffer=framebuffer;context.blendState=(_a=blendState!==null&&blendState!==void 0?blendState:framebuffer.blendState)!==null&&_a!==void 0?_a:context.blendState;context.depthTestState=(_b=depthTestState!==null&&depthTestState!==void 0?depthTestState:framebuffer.depthTestState)!==null&&_b!==void 0?_b:context.depthTestState;context.maskState=(_c=maskState!==null&&maskState!==void 0?maskState:framebuffer.maskState)!==null&&_c!==void 0?_c:context.maskState;context.cullingState=(_d=cullingState!==null&&cullingState!==void 0?cullingState:framebuffer.cullingState)!==null&&_d!==void 0?_d:context.cullingState;context.program=program;context.program.setUniformValues(uniforms);context.viewport=new Box2(new Vector2,framebuffer.size);context.renderPass(program,uniforms)}class CanvasFramebuffer extends VirtualFramebuffer{constructor(context){super(context);this.autoLayoutMode=true;this.devicePixelRatio=1;this.canvas=context.gl.canvas;this.resize()}resize(){const canvas=this.canvas;if(canvas instanceof HTMLCanvasElement){const width=Math.floor(canvas.clientWidth*this.devicePixelRatio);const height=Math.floor(canvas.clientHeight*this.devicePixelRatio);if(canvas.width!==width||canvas.height!==height){canvas.width=width;canvas.height=height}}}get size(){return new Vector2(this.context.gl.drawingBufferWidth,this.context.gl.drawingBufferHeight)}get aspectRatio(){return this.context.gl.drawingBufferWidth/this.context.gl.drawingBufferHeight}dispose(){}}var __classPrivateFieldGet=undefined&&undefined.__classPrivateFieldGet||function(receiver,privateMap){if(!privateMap.has(receiver)){throw new TypeError("attempted to get private field on non-instance")}return privateMap.get(receiver)};var _size;class Framebuffer extends VirtualFramebuffer{constructor(context){super(context);_size.set(this,new Vector2);this._attachments={};const gl=this.context.gl;{const glFramebuffer=gl.createFramebuffer();if(glFramebuffer===null){throw new Error("createFramebuffer failed")}this.glFramebuffer=glFramebuffer}this.id=this.context.registerResource(this)}attach(attachmentPoint,texImage2D,target=texImage2D.target,level=0){const gl=this.context.gl;gl.bindFramebuffer(GL.FRAMEBUFFER,this.glFramebuffer);gl.framebufferTexture2D(GL.FRAMEBUFFER,attachmentPoint,target,texImage2D.glTexture,level);this._attachments[attachmentPoint]=texImage2D;this.size.copy(texImage2D.size);gl.bindFramebuffer(GL.FRAMEBUFFER,null)}getAttachment(attachmentPoint){return this._attachments[attachmentPoint]}get size(){return __classPrivateFieldGet(this,_size)}dispose(){if(!this.disposed){const gl=this.context.gl;gl.deleteFramebuffer(this.glFramebuffer);this.context.disposeResource(this);this.disposed=true}}}_size=new WeakMap;var DataType;(function(DataType){DataType[DataType["Byte"]=GL.BYTE]="Byte";DataType[DataType["UnsignedByte"]=GL.UNSIGNED_BYTE]="UnsignedByte";DataType[DataType["Short"]=GL.SHORT]="Short";DataType[DataType["UnsignedShort"]=GL.UNSIGNED_SHORT]="UnsignedShort";DataType[DataType["Int"]=GL.INT]="Int";DataType[DataType["UnsignedInt"]=GL.UNSIGNED_INT]="UnsignedInt";DataType[DataType["Float"]=GL.FLOAT]="Float"})(DataType||(DataType={}));function sizeOfDataType(dataType){switch(dataType){case DataType.Byte:case DataType.UnsignedByte:return 1;case DataType.Short:case DataType.UnsignedShort:return 2;case DataType.Int:case DataType.UnsignedInt:case DataType.Float:return 5}throw new Error(`unsupported data type: ${dataType}`)}var PixelFormat;(function(PixelFormat){PixelFormat[PixelFormat["RGBA"]=GL.RGBA]="RGBA";PixelFormat[PixelFormat["RGB"]=GL.RGB]="RGB";PixelFormat[PixelFormat["LuminanceAlpha"]=GL.LUMINANCE_ALPHA]="LuminanceAlpha";PixelFormat[PixelFormat["Luminance"]=GL.LUMINANCE]="Luminance";PixelFormat[PixelFormat["Alpha"]=GL.ALPHA]="Alpha";PixelFormat[PixelFormat["DepthComponent"]=GL.DEPTH_COMPONENT]="DepthComponent";PixelFormat[PixelFormat["DepthStencil"]=GL.DEPTH_STENCIL]="DepthStencil"})(PixelFormat||(PixelFormat={}));function numPixelFormatComponents(pixelFormat){switch(pixelFormat){case PixelFormat.Alpha:case PixelFormat.Luminance:case PixelFormat.DepthComponent:return 1;case PixelFormat.LuminanceAlpha:case PixelFormat.DepthStencil:return 2;case PixelFormat.RGB:return 3;case PixelFormat.RGBA:return 4}throw new Error(`unsupported pixel format: ${pixelFormat}`)}var PixelEncoding;(function(PixelEncoding){PixelEncoding[PixelEncoding["Linear"]=0]="Linear";PixelEncoding[PixelEncoding["sRGB"]=1]="sRGB";PixelEncoding[PixelEncoding["RGBE"]=2]="RGBE";PixelEncoding[PixelEncoding["RGBD"]=3]="RGBD"})(PixelEncoding||(PixelEncoding={}));class ArrayBufferImage{constructor(data,width,height,dataType=DataType.UnsignedByte,pixelEncoding=PixelEncoding.sRGB){this.data=data;this.width=width;this.height=height;this.dataType=dataType;this.pixelEncoding=pixelEncoding}}var TextureFilter;(function(TextureFilter){TextureFilter[TextureFilter["LinearMipmapLinear"]=GL.LINEAR_MIPMAP_LINEAR]="LinearMipmapLinear";TextureFilter[TextureFilter["LinearMipmapNearest"]=GL.LINEAR_MIPMAP_NEAREST]="LinearMipmapNearest";TextureFilter[TextureFilter["Linear"]=GL.LINEAR]="Linear";TextureFilter[TextureFilter["Nearest"]=GL.NEAREST]="Nearest";TextureFilter[TextureFilter["NearestMipmapLinear"]=GL.NEAREST_MIPMAP_LINEAR]="NearestMipmapLinear";TextureFilter[TextureFilter["NearestMipmapNearest"]=GL.NEAREST_MIPMAP_NEAREST]="NearestMipmapNearest"})(TextureFilter||(TextureFilter={}));var TextureWrap;(function(TextureWrap){TextureWrap[TextureWrap["MirroredRepeat"]=GL.MIRRORED_REPEAT]="MirroredRepeat";TextureWrap[TextureWrap["ClampToEdge"]=GL.CLAMP_TO_EDGE]="ClampToEdge";TextureWrap[TextureWrap["Repeat"]=GL.REPEAT]="Repeat"})(TextureWrap||(TextureWrap={}));class TexParameters{constructor(){this.generateMipmaps=true;this.wrapS=TextureWrap.Repeat;this.wrapT=TextureWrap.Repeat;this.magFilter=TextureFilter.Linear;this.minFilter=TextureFilter.LinearMipmapLinear;this.anisotropyLevels=2}}var TextureTarget;(function(TextureTarget){TextureTarget[TextureTarget["Texture2D"]=GL.TEXTURE_2D]="Texture2D";TextureTarget[TextureTarget["TextureCubeMap"]=GL.TEXTURE_CUBE_MAP]="TextureCubeMap";TextureTarget[TextureTarget["CubeMapPositiveX"]=GL.TEXTURE_CUBE_MAP_POSITIVE_X]="CubeMapPositiveX";TextureTarget[TextureTarget["CubeMapNegativeX"]=GL.TEXTURE_CUBE_MAP_NEGATIVE_X]="CubeMapNegativeX";TextureTarget[TextureTarget["CubeMapPositiveY"]=GL.TEXTURE_CUBE_MAP_POSITIVE_Y]="CubeMapPositiveY";TextureTarget[TextureTarget["CubeMapNegativeY"]=GL.TEXTURE_CUBE_MAP_NEGATIVE_Y]="CubeMapNegativeY";TextureTarget[TextureTarget["CubeMapPositiveZ"]=GL.TEXTURE_CUBE_MAP_POSITIVE_Z]="CubeMapPositiveZ";TextureTarget[TextureTarget["CubeMapNegativeZ"]=GL.TEXTURE_CUBE_MAP_NEGATIVE_Z]="CubeMapNegativeZ"})(TextureTarget||(TextureTarget={}));class TexImage2D{constructor(context,images,internalFormat=PixelFormat.RGBA,dataType=DataType.UnsignedByte,pixelFormat=PixelFormat.RGBA,target=TextureTarget.Texture2D,texParameters=new TexParameters){this.context=context;this.images=images;this.internalFormat=internalFormat;this.dataType=dataType;this.pixelFormat=pixelFormat;this.target=target;this.texParameters=texParameters;this.disposed=false;this.size=new Vector2;const gl=this.context.gl;{const glTexture=gl.createTexture();if(glTexture===null){throw new Error("createTexture failed")}this.glTexture=glTexture}this.loadImages(images);gl.texParameteri(this.target,GL.TEXTURE_WRAP_S,texParameters.wrapS);gl.texParameteri(this.target,GL.TEXTURE_WRAP_T,texParameters.wrapS);gl.texParameteri(this.target,GL.TEXTURE_MAG_FILTER,texParameters.magFilter);gl.texParameteri(this.target,GL.TEXTURE_MIN_FILTER,texParameters.minFilter);if(texParameters.anisotropyLevels>1){const tfa=this.context.glxo.EXT_texture_filter_anisotropic;if(tfa!==null){const maxAllowableAnisotropy=gl.getParameter(tfa.MAX_TEXTURE_MAX_ANISOTROPY_EXT);gl.texParameterf(this.target,tfa.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(texParameters.anisotropyLevels,maxAllowableAnisotropy))}}if(texParameters.generateMipmaps){if(isPow2(this.size.width)&&isPow2(this.size.height)){gl.generateMipmap(this.target)}}gl.bindTexture(this.target,null);this.id=this.context.registerResource(this)}generateMipmaps(){const gl=this.context.gl;gl.bindTexture(this.target,this.glTexture);gl.generateMipmap(this.target);gl.bindTexture(this.target,null);this.texParameters.generateMipmaps=true}get mipCount(){if(!this.texParameters.generateMipmaps){return 1}return Math.floor(Math.log2(Math.max(this.size.width,this.size.height)))}dispose(){if(!this.disposed){this.context.gl.deleteTexture(this.glTexture);this.context.disposeResource(this);this.disposed=true}}loadImages(images){const gl=this.context.gl;gl.bindTexture(this.target,this.glTexture);if(images.length===1){this.loadImage(images[0])}else if(this.target===TextureTarget.TextureCubeMap){const numLevels=Math.floor(this.images.length/6);for(let level=0;level<numLevels;level++){for(let face=0;face<6;face++){const imageIndex=level*6+face;const image=images[imageIndex];this.loadImage(image,TextureTarget.CubeMapPositiveX+face,level)}}}else{throw new Error("Unsupported number of images")}}loadImage(image,target=undefined,level=0){const gl=this.context.gl;if(image instanceof Vector2){gl.texImage2D(target!==null&&target!==void 0?target:this.target,level,this.internalFormat,image.width,image.height,0,this.pixelFormat,this.dataType,null);if(level===0){this.size.set(image.width,image.height)}}else if(image instanceof ArrayBufferImage){gl.texImage2D(target!==null&&target!==void 0?target:this.target,level,this.internalFormat,image.width,image.height,0,this.pixelFormat,this.dataType,new Uint8Array(image.data));if(level===0){this.size.set(image.width,image.height)}}else{gl.texImage2D(target!==null&&target!==void 0?target:this.target,level,this.internalFormat,this.pixelFormat,this.dataType,image);this.size.set(image.width,image.height)}}}function readPixelsFromFramebuffer(framebuffer,pixelBuffer=undefined){const context=framebuffer.context;context.framebuffer=framebuffer;const gl=context.gl;const status=gl.checkFramebufferStatus(GL.FRAMEBUFFER);if(status!==GL.FRAMEBUFFER_COMPLETE){throw new Error(`can not read non-complete Framebuffer: ${status}`)}const texImage2D=framebuffer.getAttachment(exports.Attachment.Color0);if(texImage2D===undefined){throw new Error("no attachment on Color0")}const pixelByteLength=sizeOfDataType(texImage2D.dataType)*numPixelFormatComponents(texImage2D.pixelFormat)*texImage2D.size.width*texImage2D.size.height;if(pixelBuffer===undefined){pixelBuffer=new Uint8Array(pixelByteLength)}if(pixelBuffer.byteLength<pixelByteLength){throw new Error(`pixelBuffer too small: ${pixelBuffer.byteLength} < ${pixelByteLength}`)}gl.readPixels(0,0,texImage2D.size.width,texImage2D.size.height,texImage2D.pixelFormat,texImage2D.dataType,pixelBuffer);return pixelBuffer}function makeColorAttachment(context,size,dataType=undefined){const texParams=new TexParameters;texParams.generateMipmaps=false;texParams.magFilter=TextureFilter.Linear;texParams.minFilter=TextureFilter.Linear;return new TexImage2D(context,[size],PixelFormat.RGBA,dataType!==null&&dataType!==void 0?dataType:DataType.UnsignedByte,PixelFormat.RGBA,TextureTarget.Texture2D,texParams)}function makeDepthAttachment(context,size){const texParams=new TexParameters;texParams.generateMipmaps=false;texParams.magFilter=TextureFilter.Nearest;texParams.minFilter=TextureFilter.Nearest;const dataType=DataType.UnsignedShort;return new TexImage2D(context,[size],PixelFormat.DepthComponent,dataType,PixelFormat.DepthComponent,TextureTarget.Texture2D,texParams)}exports.CanvasFramebuffer=CanvasFramebuffer;exports.Framebuffer=Framebuffer;exports.VirtualFramebuffer=VirtualFramebuffer;exports.makeColorAttachment=makeColorAttachment;exports.makeDepthAttachment=makeDepthAttachment;exports.readPixelsFromFramebuffer=readPixelsFromFramebuffer;exports.renderBufferGeometry=renderBufferGeometry;exports.renderPass=renderPass;exports.renderVertexArrayObject=renderVertexArrayObject;return exports})({});